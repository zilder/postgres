--
-- Tests for date_trunc optimization in the planner over timestamp fields.
--

CREATE TABLE TIMESTAMP_OPTIM_TBL (d1 TIMESTAMP(2) without time zone);

INSERT INTO TIMESTAMP_OPTIM_TBL VALUES ('1957-04-09');
INSERT INTO TIMESTAMP_OPTIM_TBL VALUES ('1957-06-13');
INSERT INTO TIMESTAMP_OPTIM_TBL VALUES ('1990-01-01');
INSERT INTO TIMESTAMP_OPTIM_TBL VALUES ('1990-05-01');
INSERT INTO TIMESTAMP_OPTIM_TBL VALUES ('1991-01-01');
INSERT INTO TIMESTAMP_OPTIM_TBL VALUES ('1996-02-28');
INSERT INTO TIMESTAMP_OPTIM_TBL VALUES ('1996-02-29');
INSERT INTO TIMESTAMP_OPTIM_TBL VALUES ('1996-03-01');
INSERT INTO TIMESTAMP_OPTIM_TBL VALUES ('1996-03-02');
INSERT INTO TIMESTAMP_OPTIM_TBL VALUES ('1997-02-28');
INSERT INTO TIMESTAMP_OPTIM_TBL VALUES ('1997-03-01');
INSERT INTO TIMESTAMP_OPTIM_TBL VALUES ('1997-03-02');
INSERT INTO TIMESTAMP_OPTIM_TBL VALUES ('2000-01-01');
INSERT INTO TIMESTAMP_OPTIM_TBL VALUES ('2000-04-01');
INSERT INTO TIMESTAMP_OPTIM_TBL VALUES ('2000-04-02');
INSERT INTO TIMESTAMP_OPTIM_TBL VALUES ('2000-04-03');
INSERT INTO TIMESTAMP_OPTIM_TBL VALUES ('2001-01-01');
INSERT INTO TIMESTAMP_OPTIM_TBL VALUES ('2038-04-08');
INSERT INTO TIMESTAMP_OPTIM_TBL VALUES ('2039-04-09');
INSERT INTO TIMESTAMP_OPTIM_TBL VALUES ('2040-04-10');

-- date_trunc greater than operation optimization
-- timestamp comparison
EXPLAIN SELECT d1 AS date_trunc_optim_gt from TIMESTAMP_OPTIM_TBL
  WHERE DATE_TRUNC('DECADE', d1) > TIMESTAMP '1992-01-01';
SELECT d1 AS date_trunc_optim_gt from TIMESTAMP_OPTIM_TBL WHERE TIMESTAMP '1992-01-01' < DATE_TRUNC('DECADE', d1);
SELECT d1 AS date_trunc_optim_gt from TIMESTAMP_OPTIM_TBL WHERE DATE_TRUNC('DECADE', d1) > TIMESTAMP '1992-01-01';

-- date_trunc greater than or equal operation optimization
-- timestamp comparison
EXPLAIN SELECT d1 AS date_trunc_optim_ge from TIMESTAMP_OPTIM_TBL
  WHERE DATE_TRUNC('DECADE', d1) >= TIMESTAMP '1993-12-25';
SELECT d1 AS date_trunc_optim_ge from TIMESTAMP_OPTIM_TBL WHERE TIMESTAMP '1993-12-25' <= DATE_TRUNC('DECADE', d1);
SELECT d1 AS date_trunc_optim_ge from TIMESTAMP_OPTIM_TBL WHERE DATE_TRUNC('DECADE', d1) >= TIMESTAMP '1993-12-25';

-- timestamp comparison
EXPLAIN SELECT d1 AS date_trunc_optim_ge from TIMESTAMP_OPTIM_TBL
  WHERE TIMESTAMP '1990-01-01' <= DATE_TRUNC('DECADE', d1);
SELECT d1 AS date_trunc_optim_ge from TIMESTAMP_OPTIM_TBL WHERE TIMESTAMP '1990-01-01' <= DATE_TRUNC('DECADE', d1);
SELECT d1 AS date_trunc_optim_ge from TIMESTAMP_OPTIM_TBL WHERE DATE_TRUNC('DECADE', d1) >= TIMESTAMP '1990-01-01';

-- date_trunc less than operation optimization
-- timestamp comparison
EXPLAIN SELECT d1 AS date_trunc_optim_lt from TIMESTAMP_OPTIM_TBL
  WHERE TIMESTAMP '1991-01-01' > DATE_TRUNC('DECADE', d1);
SELECT d1 AS date_trunc_optim_lt from TIMESTAMP_OPTIM_TBL WHERE TIMESTAMP '1991-01-01' > DATE_TRUNC('DECADE', d1);
SELECT d1 AS date_trunc_optim_lt from TIMESTAMP_OPTIM_TBL WHERE DATE_TRUNC('DECADE', d1) < TIMESTAMP '1991-01-01';

-- date_trunc greater than or equal operation optimization
-- timestamp comparison
EXPLAIN SELECT d1 AS date_trunc_optim_le from TIMESTAMP_OPTIM_TBL
  WHERE TIMESTAMP '1993-01-01' >= DATE_TRUNC('DECADE', d1);
SELECT d1 AS date_trunc_optim_le from TIMESTAMP_OPTIM_TBL WHERE TIMESTAMP '1993-01-01' >= DATE_TRUNC('DECADE', d1);
SELECT d1 AS date_trunc_optim_le from TIMESTAMP_OPTIM_TBL WHERE DATE_TRUNC('DECADE', d1) <= TIMESTAMP '1993-01-01';

-- timestamp comparison
EXPLAIN SELECT d1 AS date_trunc_optim_le from TIMESTAMP_OPTIM_TBL
  WHERE TIMESTAMP '1990-01-01' >= DATE_TRUNC('DECADE', d1);
SELECT d1 AS date_trunc_optim_le from TIMESTAMP_OPTIM_TBL WHERE TIMESTAMP '1990-01-01' >= DATE_TRUNC('DECADE', d1);
SELECT d1 AS date_trunc_optim_le from TIMESTAMP_OPTIM_TBL WHERE DATE_TRUNC('DECADE', d1) <= TIMESTAMP '1990-01-01';

CREATE TABLE TIMESTAMP2_TBL (d2 TIMESTAMP(2) without time zone);

-- Special values
INSERT INTO TIMESTAMP2_TBL VALUES ('Feb 15 17:32:01 1997');
INSERT INTO TIMESTAMP2_TBL VALUES ('Feb 16 17:32:01 1997');
INSERT INTO TIMESTAMP2_TBL VALUES ('Feb 26 17:32:01 1997');
INSERT INTO TIMESTAMP2_TBL VALUES ('Feb 27 17:32:01 1997');
INSERT INTO TIMESTAMP2_TBL VALUES ('Feb 28 17:32:01 1997');
INSERT INTO TIMESTAMP2_TBL VALUES ('Feb 16 17:32:01 0097 BC');
INSERT INTO TIMESTAMP2_TBL VALUES ('Feb 16 17:32:01 1797');
INSERT INTO TIMESTAMP2_TBL VALUES ('Feb 16 17:32:01 1897');
INSERT INTO TIMESTAMP2_TBL VALUES ('Feb 16 17:32:01 1997');
INSERT INTO TIMESTAMP2_TBL VALUES ('Feb 16 17:32:01 2097');
INSERT INTO TIMESTAMP2_TBL VALUES ('Feb 28 17:32:01 1996');
INSERT INTO TIMESTAMP2_TBL VALUES ('Mar 01 17:32:01 1996');
INSERT INTO TIMESTAMP2_TBL VALUES ('Dec 30 17:32:01 1996');
INSERT INTO TIMESTAMP2_TBL VALUES ('Dec 31 17:32:01 1996');
INSERT INTO TIMESTAMP2_TBL VALUES ('Jan 01 17:32:01 1997');
INSERT INTO TIMESTAMP2_TBL VALUES ('Feb 28 17:32:01 1997');
INSERT INTO TIMESTAMP2_TBL VALUES ('Mar 01 17:32:01 1997');
INSERT INTO TIMESTAMP2_TBL VALUES ('Dec 30 17:32:01 1997');
INSERT INTO TIMESTAMP2_TBL VALUES ('Dec 31 17:32:01 1997');
INSERT INTO TIMESTAMP2_TBL VALUES ('Dec 31 17:32:01 1999');
INSERT INTO TIMESTAMP2_TBL VALUES ('Jan 01 17:32:01 2000');
INSERT INTO TIMESTAMP2_TBL VALUES ('Dec 31 17:32:01 2000');
INSERT INTO TIMESTAMP2_TBL VALUES ('Jan 01 17:32:01 2001');

SELECT d2 AS timestamp_trunc_optim from TIMESTAMP2_TBL
  WHERE DATE_TRUNC('WEEK', d2) >= timestamp '1997-02-28 15:44:17.71393';

SELECT d2 AS timestamp_trunc_optim from TIMESTAMP2_TBL
  WHERE DATE_TRUNC('WEEK', d2) >= timestamp '1997-02-23 00:00:00.00000';

SELECT d2 AS timestamp_trunc_optim from TIMESTAMP2_TBL
  WHERE DATE_TRUNC('WEEK', d2) < timestamp '1997-02-28 15:44:17.71393';

SELECT d2 AS timestamp_trunc_optim from TIMESTAMP2_TBL
  WHERE DATE_TRUNC('WEEK', d2) <= timestamp '1997-02-28 15:44:17.71393';

SELECT d2 AS timestamp_trunc_optim from TIMESTAMP2_TBL
  WHERE DATE_TRUNC('WEEK', d2) <= timestamp '1997-02-23 00:00:00.00000';

SELECT d2 AS timestamp_trunc_optim from TIMESTAMP2_TBL
  WHERE DATE_TRUNC('DAY', d2) > timestamp '1997-02-28 15:44:17.71393';

SELECT d2 AS timestamp_trunc_optim from TIMESTAMP2_TBL
  WHERE DATE_TRUNC('WEEK', d2) > timestamp '1997-02-28 15:44:17.71393';

SELECT d2 AS timestamp_trunc_optim from TIMESTAMP2_TBL
  WHERE DATE_TRUNC('MONTH', d2) > timestamp '1997-02-28 15:44:17.71393';

SELECT d2 AS timestamp_trunc_optim from TIMESTAMP2_TBL
  WHERE DATE_TRUNC('YEAR', d2) > timestamp '1997-02-28 15:44:17.71393';

SELECT d2 AS timestamp_trunc_optim from TIMESTAMP2_TBL
  WHERE DATE_TRUNC('DECADE', d2) > timestamp '1997-02-28 15:44:17.71393';

SELECT d2 AS timestamp_trunc_optim from TIMESTAMP2_TBL
  WHERE DATE_TRUNC('CENTURY', d2) > timestamp '1997-02-28 15:44:17.71393';

SELECT d2 AS timestamp_trunc_optim from TIMESTAMP2_TBL
  WHERE DATE_TRUNC('MILLENNIUM', d2) > timestamp '1997-02-28 15:44:17.71393';

CREATE INDEX idx on TIMESTAMP2_TBL (d2);
--
-- Tests for date_trunc optimization for joins.
--

EXPLAIN SELECT d1, d2 from TIMESTAMP_OPTIM_TBL tso join TIMESTAMP2_TBL ts on tso.d1 > DATE_TRUNC('week', ts.d2);
SELECT d1, d2 from TIMESTAMP_OPTIM_TBL tso join TIMESTAMP2_TBL ts on tso.d1 > DATE_TRUNC('week', ts.d2);

DROP TABLE TIMESTAMP_OPTIM_TBL;
DROP TABLE TIMESTAMP2_TBL;